name: cd

on:
  workflow_run:
    workflows: [ci]
    branches: [main]
    types: [completed]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: cd-prod
  cancel-in-progress: false

env:
  RESOURCE_GROUP: rg-codec-prod
  ACR_NAME: acrcodecprod
  API_APP_NAME: ca-codec-prod-api
  WEB_APP_NAME: ca-codec-prod-web

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    outputs:
      image-tag: ${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push API image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/codec-api:${{ github.sha }} \
                        -t ${{ env.ACR_NAME }}.azurecr.io/codec-api:latest \
                        ./apps/api
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-api:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-api:latest

      - name: Build and push Web image
        run: |
          docker build \
            --build-arg PUBLIC_API_BASE_URL=${{ secrets.PUBLIC_API_BASE_URL }} \
            --build-arg PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.PUBLIC_GOOGLE_CLIENT_ID }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/codec-web:${{ github.sha }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/codec-web:latest \
            ./apps/web
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-web:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-web:latest

  migrate-database:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef --version 10.0.3

      - name: Restore and build
        working-directory: apps/api
        run: |
          dotnet restore Codec.Api/Codec.Api.csproj
          dotnet build Codec.Api/Codec.Api.csproj -c Release --no-restore

      - name: Build migration bundle
        working-directory: apps/api
        run: |
          dotnet ef migrations bundle \
            --project Codec.Api \
            --configuration Release \
            --no-build \
            --output ../../efbundle \
            --self-contained \
            --target-runtime linux-x64 \
            --force \
            --verbose

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Open PostgreSQL firewall for runner
        id: firewall
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          az postgres flexible-server firewall-rule create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name psql-codec-prod \
            --rule-name AllowGitHubRunner \
            --start-ip-address "$RUNNER_IP" \
            --end-ip-address "$RUNNER_IP"
          echo "opened=true" >> "$GITHUB_OUTPUT"

      - name: Run migrations
        run: |
          CONNECTION_STRING=$(az keyvault secret show \
            --vault-name kv-codec-prod \
            --name ConnectionStrings--Default \
            --query value -o tsv)
          chmod +x ./efbundle
          ./efbundle --connection "$CONNECTION_STRING"

      - name: Close PostgreSQL firewall rule
        if: always() && steps.firewall.outputs.opened == 'true'
        run: |
          az postgres flexible-server firewall-rule delete \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name psql-codec-prod \
            --rule-name AllowGitHubRunner \
            --yes

  deploy:
    runs-on: ubuntu-latest
    needs: migrate-database
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy infrastructure (register hostnames and create certificates)
        run: |
          az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters \
              location='centralus' \
              environmentName='prod' \
              googleClientId='${{ secrets.GOOGLE_CLIENT_ID }}' \
              postgresqlAdminPassword='${{ secrets.POSTGRESQL_ADMIN_PASSWORD }}' \
              apiContainerImage='${{ env.ACR_NAME }}.azurecr.io/codec-api:${{ github.sha }}' \
              webContainerImage='${{ env.ACR_NAME }}.azurecr.io/codec-web:${{ github.sha }}' \
              webCustomDomain='codec-chat.com' \
              apiCustomDomain='api.codec-chat.com' \
              bindCertificates=false

      - name: Deploy infrastructure (bind certificates to custom domains)
        run: |
          az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters \
              location='centralus' \
              environmentName='prod' \
              googleClientId='${{ secrets.GOOGLE_CLIENT_ID }}' \
              postgresqlAdminPassword='${{ secrets.POSTGRESQL_ADMIN_PASSWORD }}' \
              apiContainerImage='${{ env.ACR_NAME }}.azurecr.io/codec-api:${{ github.sha }}' \
              webContainerImage='${{ env.ACR_NAME }}.azurecr.io/codec-web:${{ github.sha }}' \
              webCustomDomain='codec-chat.com' \
              apiCustomDomain='api.codec-chat.com' \
              bindCertificates=true

  smoke-test:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get application FQDNs
        id: fqdns
        run: |
          API_FQDN=$(az containerapp show \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          WEB_FQDN=$(az containerapp show \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "api-fqdn=$API_FQDN" >> "$GITHUB_OUTPUT"
          echo "web-fqdn=$WEB_FQDN" >> "$GITHUB_OUTPUT"

      - name: Smoke test API health
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ steps.fqdns.outputs.api-fqdn }}/health/ready")
          if [ "$STATUS" != "200" ]; then
            echo "API health check failed with status $STATUS"
            exit 1
          fi
          echo "API health check passed (HTTP $STATUS)"

      - name: Smoke test Web health
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ steps.fqdns.outputs.web-fqdn }}/health")
          if [ "$STATUS" != "200" ]; then
            echo "Web health check failed with status $STATUS"
            exit 1
          fi
          echo "Web health check passed (HTTP $STATUS)"
