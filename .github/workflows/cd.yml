name: cd

on:
  workflow_run:
    workflows: [ci]
    branches: [main]
    types: [completed]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: cd-prod
  cancel-in-progress: false

env:
  RESOURCE_GROUP: rg-codec-prod
  ACR_NAME: acrcodecprod
  API_APP_NAME: ca-codec-prod-api
  WEB_APP_NAME: ca-codec-prod-web

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    outputs:
      image-tag: ${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push API image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/codec-api:${{ github.sha }} \
                        -t ${{ env.ACR_NAME }}.azurecr.io/codec-api:latest \
                        ./apps/api
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-api:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-api:latest

      - name: Build and push Web image
        run: |
          docker build \
            --build-arg PUBLIC_API_BASE_URL=${{ secrets.PUBLIC_API_BASE_URL }} \
            --build-arg PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.PUBLIC_GOOGLE_CLIENT_ID }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/codec-web:${{ github.sha }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/codec-web:latest \
            ./apps/web
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-web:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-web:latest

  migrate-database:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef --version 10.0.3

      - name: Restore and build
        working-directory: apps/api
        run: |
          dotnet restore Codec.Api/Codec.Api.csproj
          dotnet build Codec.Api/Codec.Api.csproj -c Release --no-restore

      - name: Build migration bundle
        working-directory: apps/api
        run: |
          dotnet ef migrations bundle \
            --project Codec.Api \
            --configuration Release \
            --no-build \
            --output ../../efbundle \
            --self-contained \
            --target-runtime linux-x64 \
            --force \
            --verbose

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Open PostgreSQL firewall for runner
        id: firewall
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          az postgres flexible-server firewall-rule create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name psql-codec-prod \
            --rule-name AllowGitHubRunner \
            --start-ip-address "$RUNNER_IP" \
            --end-ip-address "$RUNNER_IP"
          echo "opened=true" >> "$GITHUB_OUTPUT"

      - name: Run migrations
        run: |
          CONNECTION_STRING=$(az keyvault secret show \
            --vault-name kv-codec-prod \
            --name ConnectionStrings--Default \
            --query value -o tsv)
          chmod +x ./efbundle
          ./efbundle --connection "$CONNECTION_STRING"

      - name: Close PostgreSQL firewall rule
        if: always() && steps.firewall.outputs.opened == 'true'
        run: |
          az postgres flexible-server firewall-rule delete \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name psql-codec-prod \
            --rule-name AllowGitHubRunner \
            --yes

  deploy:
    runs-on: ubuntu-latest
    needs: migrate-database
    environment: prod
    outputs:
      api-revision: ${{ steps.deploy-api.outputs.revision }}
      web-revision: ${{ steps.deploy-web.outputs.revision }}
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure multiple revision mode
        run: |
          az containerapp revision set-mode \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --mode multiple
          az containerapp revision set-mode \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --mode multiple

      - name: Deploy API staging revision
        id: deploy-api
        run: |
          SUFFIX="gh$(echo $GITHUB_SHA | cut -c1-7)r${{ github.run_attempt }}"
          az containerapp update \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/codec-api:${{ github.sha }} \
            --revision-suffix "$SUFFIX" \
            --min-replicas 1
          echo "revision=${{ env.API_APP_NAME }}--${SUFFIX}" >> "$GITHUB_OUTPUT"

      - name: Deploy Web staging revision
        id: deploy-web
        run: |
          SUFFIX="gh$(echo $GITHUB_SHA | cut -c1-7)r${{ github.run_attempt }}"
          az containerapp update \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/codec-web:${{ github.sha }} \
            --revision-suffix "$SUFFIX" \
            --min-replicas 1
          echo "revision=${{ env.WEB_APP_NAME }}--${SUFFIX}" >> "$GITHUB_OUTPUT"

      - name: Wait for staging revisions to be ready
        run: |
          for APP_REVISION in "${{ steps.deploy-api.outputs.revision }}" "${{ steps.deploy-web.outputs.revision }}"; do
            APP_NAME=$(echo "$APP_REVISION" | sed 's/--.*$//')
            echo "Waiting for revision $APP_REVISION..."
            for i in $(seq 1 30); do
              STATUS=$(az containerapp revision show \
                --name "$APP_NAME" \
                --resource-group ${{ env.RESOURCE_GROUP }} \
                --revision "$APP_REVISION" \
                --query properties.runningState -o tsv 2>/dev/null || echo "Unknown")
              if [ "$STATUS" = "Running" ] || [ "$STATUS" = "Degraded" ]; then
                echo "Revision $APP_REVISION is running (status: $STATUS)"
                break
              fi
              if [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Stopped" ]; then
                echo "Revision $APP_REVISION failed to start (status: $STATUS)"
                exit 1
              fi
              if [ "$i" = "30" ]; then
                echo "Timed out waiting for revision $APP_REVISION (last status: $STATUS)"
                exit 1
              fi
              echo "  Attempt $i/30 — status: $STATUS"
              sleep 10
            done
          done

      - name: Label staging revisions for health checking
        run: |
          az containerapp revision label remove \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --label staging 2>/dev/null || true
          az containerapp revision label add \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --label staging \
            --revision "${{ steps.deploy-api.outputs.revision }}"

          az containerapp revision label remove \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --label staging 2>/dev/null || true
          az containerapp revision label add \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --label staging \
            --revision "${{ steps.deploy-web.outputs.revision }}"

      - name: Health check staging revisions
        run: |
          API_FQDN=$(az containerapp show \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          # Azure Container Apps uses the `staging---<fqdn>` host pattern for label-based routing; the triple dash is required and intentional.
          STAGING_API_URL="https://staging---${API_FQDN}"

          echo "Checking staging API at ${STAGING_API_URL}/health/ready"
          for i in $(seq 1 10); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${STAGING_API_URL}/health/ready" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "API staging health check passed (HTTP $STATUS)"
              break
            fi
            if [ "$i" = "10" ]; then
              echo "API staging health check failed (last status: $STATUS)"
              exit 1
            fi
            echo "  Attempt $i/10 — HTTP $STATUS"
            sleep 10
          done

          WEB_FQDN=$(az containerapp show \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          STAGING_WEB_URL="https://staging---${WEB_FQDN}"

          echo "Checking staging Web at ${STAGING_WEB_URL}/health"
          for i in $(seq 1 10); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${STAGING_WEB_URL}/health" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "Web staging health check passed (HTTP $STATUS)"
              break
            fi
            if [ "$i" = "10" ]; then
              echo "Web staging health check failed (last status: $STATUS)"
              exit 1
            fi
            echo "  Attempt $i/10 — HTTP $STATUS"
            sleep 10
          done

      - name: Switch traffic to new revisions
        run: |
          az containerapp ingress traffic set \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --revision-weight "${{ steps.deploy-api.outputs.revision }}=100"

          az containerapp ingress traffic set \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --revision-weight "${{ steps.deploy-web.outputs.revision }}=100"

      - name: Deactivate old revisions
        run: |
          OLD_API=$(az containerapp revision list \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[?name!='${{ steps.deploy-api.outputs.revision }}' && properties.active].name" -o tsv)
          for rev in $OLD_API; do
            echo "Deactivating API revision: $rev"
            az containerapp revision deactivate \
              --name ${{ env.API_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --revision "$rev"
          done

          OLD_WEB=$(az containerapp revision list \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[?name!='${{ steps.deploy-web.outputs.revision }}' && properties.active].name" -o tsv)
          for rev in $OLD_WEB; do
            echo "Deactivating Web revision: $rev"
            az containerapp revision deactivate \
              --name ${{ env.WEB_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --revision "$rev"
          done

      - name: Remove staging labels
        if: always()
        run: |
          az containerapp revision label remove \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --label staging 2>/dev/null || true
          az containerapp revision label remove \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --label staging 2>/dev/null || true

      - name: Rollback — deactivate failed staging revisions
        if: failure()
        run: |
          az containerapp revision deactivate \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --revision "${{ steps.deploy-api.outputs.revision }}" 2>/dev/null || true
          az containerapp revision deactivate \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --revision "${{ steps.deploy-web.outputs.revision }}" 2>/dev/null || true

  smoke-test:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get application FQDNs
        id: fqdns
        run: |
          API_FQDN=$(az containerapp show \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          WEB_FQDN=$(az containerapp show \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "api-fqdn=$API_FQDN" >> "$GITHUB_OUTPUT"
          echo "web-fqdn=$WEB_FQDN" >> "$GITHUB_OUTPUT"

      - name: Smoke test API health
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ steps.fqdns.outputs.api-fqdn }}/health/ready")
          if [ "$STATUS" != "200" ]; then
            echo "API health check failed with status $STATUS"
            exit 1
          fi
          echo "API health check passed (HTTP $STATUS)"

      - name: Smoke test Web health
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ steps.fqdns.outputs.web-fqdn }}/health")
          if [ "$STATUS" != "200" ]; then
            echo "Web health check failed with status $STATUS"
            exit 1
          fi
          echo "Web health check passed (HTTP $STATUS)"
