name: cd

on:
  workflow_run:
    workflows: [ci]
    branches: [main]
    types: [completed]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: cd-prod
  cancel-in-progress: false

env:
  RESOURCE_GROUP: rg-codec-prod
  ACR_NAME: acrcodecprod
  API_APP_NAME: ca-codec-prod-api
  WEB_APP_NAME: ca-codec-prod-web

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    outputs:
      image-tag: ${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push API image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/codec-api:${{ github.sha }} \
                        -t ${{ env.ACR_NAME }}.azurecr.io/codec-api:latest \
                        ./apps/api
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-api:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-api:latest

      - name: Build and push Web image
        run: |
          docker build \
            --build-arg PUBLIC_API_BASE_URL=${{ secrets.PUBLIC_API_BASE_URL }} \
            --build-arg PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.PUBLIC_GOOGLE_CLIENT_ID }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/codec-web:${{ github.sha }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/codec-web:latest \
            ./apps/web
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-web:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-web:latest

  migrate-database:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef

      - name: Build migration bundle
        working-directory: apps/api
        run: |
          dotnet ef migrations bundle \
            --project Codec.Api \
            --output ../../efbundle \
            --self-contained \
            --force

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run migrations
        run: |
          CONNECTION_STRING=$(az keyvault secret show \
            --vault-name kv-codec-prod \
            --name ConnectionStrings--Default \
            --query value -o tsv)
          chmod +x ./efbundle
          ./efbundle --connection "$CONNECTION_STRING"

  deploy:
    runs-on: ubuntu-latest
    needs: migrate-database
    environment: prod
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy API Container App
        run: |
          az containerapp update \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/codec-api:${{ github.sha }}

      - name: Deploy Web Container App
        run: |
          az containerapp update \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/codec-web:${{ github.sha }}

      - name: Wait for revisions to become active
        run: |
          echo "Waiting for API revision..."
          az containerapp revision list \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[?properties.active].name" -o tsv

          echo "Waiting for Web revision..."
          az containerapp revision list \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[?properties.active].name" -o tsv

  smoke-test:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get application FQDNs
        id: fqdns
        run: |
          API_FQDN=$(az containerapp show \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          WEB_FQDN=$(az containerapp show \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "api-fqdn=$API_FQDN" >> "$GITHUB_OUTPUT"
          echo "web-fqdn=$WEB_FQDN" >> "$GITHUB_OUTPUT"

      - name: Smoke test API health
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ steps.fqdns.outputs.api-fqdn }}/health/ready")
          if [ "$STATUS" != "200" ]; then
            echo "API health check failed with status $STATUS"
            exit 1
          fi
          echo "API health check passed (HTTP $STATUS)"

      - name: Smoke test Web health
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ steps.fqdns.outputs.web-fqdn }}/health")
          if [ "$STATUS" != "200" ]; then
            echo "Web health check failed with status $STATUS"
            exit 1
          fi
          echo "Web health check passed (HTTP $STATUS)"
