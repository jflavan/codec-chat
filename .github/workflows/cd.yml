name: cd

on:
  workflow_run:
    workflows: [ci]
    branches: [main]
    types: [completed]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: cd-prod
  cancel-in-progress: false

env:
  RESOURCE_GROUP: rg-codec-prod
  ACR_NAME: acrcodecprod
  API_APP_NAME: ca-codec-prod-api
  WEB_APP_NAME: ca-codec-prod-web

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    outputs:
      image-tag: ${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push API image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/codec-api:${{ github.sha }} \
                        -t ${{ env.ACR_NAME }}.azurecr.io/codec-api:latest \
                        ./apps/api
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-api:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-api:latest

      - name: Build and push Web image
        run: |
          docker build \
            --build-arg PUBLIC_API_BASE_URL=${{ secrets.PUBLIC_API_BASE_URL }} \
            --build-arg PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.PUBLIC_GOOGLE_CLIENT_ID }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/codec-web:${{ github.sha }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/codec-web:latest \
            ./apps/web
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-web:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/codec-web:latest

  migrate-database:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef --version 10.0.3

      - name: Restore and build
        working-directory: apps/api
        run: |
          dotnet restore Codec.Api/Codec.Api.csproj
          dotnet build Codec.Api/Codec.Api.csproj -c Release --no-restore

      - name: Build migration bundle
        working-directory: apps/api
        run: |
          dotnet ef migrations bundle \
            --project Codec.Api \
            --configuration Release \
            --no-build \
            --output ../../efbundle \
            --self-contained \
            --target-runtime linux-x64 \
            --force \
            --verbose

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Open PostgreSQL firewall for runner
        id: firewall
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          az postgres flexible-server firewall-rule create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name psql-codec-prod \
            --rule-name AllowGitHubRunner \
            --start-ip-address "$RUNNER_IP" \
            --end-ip-address "$RUNNER_IP"
          echo "opened=true" >> "$GITHUB_OUTPUT"

      - name: Run migrations
        run: |
          CONNECTION_STRING=$(az keyvault secret show \
            --vault-name kv-codec-prod \
            --name ConnectionStrings--Default \
            --query value -o tsv)
          chmod +x ./efbundle
          ./efbundle --connection "$CONNECTION_STRING"

      - name: Set GlobalAdmin email in Key Vault
        run: |
          az keyvault secret set \
            --vault-name kv-codec-prod \
            --name GlobalAdmin--Email \
            --value "${{ secrets.GLOBAL_ADMIN_EMAIL }}"

      - name: Close PostgreSQL firewall rule
        if: always() && steps.firewall.outputs.opened == 'true'
        run: |
          az postgres flexible-server firewall-rule delete \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name psql-codec-prod \
            --rule-name AllowGitHubRunner \
            --yes

  deploy:
    runs-on: ubuntu-latest
    needs: migrate-database
    environment: prod
    outputs:
      api-revision: ${{ steps.deploy-api.outputs.revision }}
      web-revision: ${{ steps.deploy-web.outputs.revision }}
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure multiple revision mode
        run: |
          az containerapp revision set-mode \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --mode multiple
          az containerapp revision set-mode \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --mode multiple

      - name: Ensure container app registries
        run: |
          for APP in "${{ env.API_APP_NAME }}" "${{ env.WEB_APP_NAME }}"; do
            echo "Ensuring ACR registry on $APP..."
            az containerapp registry set \
              --name "$APP" \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --server ${{ env.ACR_NAME }}.azurecr.io \
              --identity system
          done

      - name: Deploy API staging revision
        id: deploy-api
        run: |
          SUFFIX="gh$(echo $GITHUB_SHA | cut -c1-7)r${{ github.run_attempt }}"
          RESULT=$(az containerapp update \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/codec-api:${{ github.sha }} \
            --revision-suffix "$SUFFIX" \
            --min-replicas 1 \
            -o json)
          REVISION_NAME=$(echo "$RESULT" | jq -r '.properties.latestRevisionName')
          echo "Created revision: $REVISION_NAME"
          echo "revision=$REVISION_NAME" >> "$GITHUB_OUTPUT"

      - name: Deploy Web staging revision
        id: deploy-web
        run: |
          SUFFIX="gh$(echo $GITHUB_SHA | cut -c1-7)r${{ github.run_attempt }}"
          RESULT=$(az containerapp update \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/codec-web:${{ github.sha }} \
            --revision-suffix "$SUFFIX" \
            --min-replicas 1 \
            -o json)
          REVISION_NAME=$(echo "$RESULT" | jq -r '.properties.latestRevisionName')
          echo "Created revision: $REVISION_NAME"
          echo "revision=$REVISION_NAME" >> "$GITHUB_OUTPUT"

      - name: Wait for staging revisions to be ready
        run: |
          for APP_REVISION in "${{ steps.deploy-api.outputs.revision }}" "${{ steps.deploy-web.outputs.revision }}"; do
            APP_NAME=$(echo "$APP_REVISION" | sed 's/--.*$//')
            echo "Waiting for revision $APP_REVISION..."
            for i in $(seq 1 60); do
              DETAIL=$(az containerapp revision show \
                --name "$APP_NAME" \
                --resource-group ${{ env.RESOURCE_GROUP }} \
                --revision "$APP_REVISION" \
                --query '{runningState:properties.runningState,healthState:properties.healthState,replicas:properties.replicas,active:properties.active}' \
                -o json 2>/dev/null || echo '{"runningState":"Unknown"}')
              STATUS=$(echo "$DETAIL" | jq -r '.runningState // "Unknown"')
              HEALTH=$(echo "$DETAIL" | jq -r '.healthState // "Unknown"')
              echo "  Attempt $i/60 — status=$STATUS health=$HEALTH detail=$DETAIL"
              if [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Stopped" ]; then
                echo "::error::Revision $APP_REVISION failed to start (status: $STATUS)"
                echo "--- Full revision details ---"
                az containerapp revision show \
                  --name "$APP_NAME" \
                  --resource-group ${{ env.RESOURCE_GROUP }} \
                  --revision "$APP_REVISION" 2>/dev/null || true
                echo "--- Recent container logs ---"
                az containerapp logs show \
                  --name "$APP_NAME" \
                  --resource-group ${{ env.RESOURCE_GROUP }} \
                  --tail 50 --type system 2>/dev/null || true
                exit 1
              fi
              # Accept any running state combined with a healthy (or undetermined) health state
              if [ "$STATUS" = "Running" ] || [ "$STATUS" = "Degraded" ] || [ "$STATUS" = "RunningAtMaxScale" ]; then
                if [ "$HEALTH" = "Healthy" ] || [ "$HEALTH" = "None" ]; then
                  echo "Revision $APP_REVISION is ready (status: $STATUS, health: $HEALTH)"
                  break
                fi
                echo "  Revision is running but health is $HEALTH, continuing to wait..."
              fi
              if [ "$i" = "60" ]; then
                echo "::error::Timed out waiting for revision $APP_REVISION (last status: $STATUS, health: $HEALTH)"
                echo "--- Full revision details ---"
                az containerapp revision show \
                  --name "$APP_NAME" \
                  --resource-group ${{ env.RESOURCE_GROUP }} \
                  --revision "$APP_REVISION" 2>/dev/null || true
                echo "--- Recent container logs ---"
                az containerapp logs show \
                  --name "$APP_NAME" \
                  --resource-group ${{ env.RESOURCE_GROUP }} \
                  --tail 50 --type system 2>/dev/null || true
                exit 1
              fi
              sleep 10
            done
          done

      - name: Verify staging revisions are healthy
        run: |
          for APP_REVISION in "${{ steps.deploy-api.outputs.revision }}" "${{ steps.deploy-web.outputs.revision }}"; do
            APP_NAME=$(echo "$APP_REVISION" | sed 's/--.*$//')
            DETAIL=$(az containerapp revision show \
              --name "$APP_NAME" \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --revision "$APP_REVISION" \
              --query '{runningState:properties.runningState,healthState:properties.healthState,replicas:properties.replicas,active:properties.active}' \
              -o json)
            echo "Pre-switch check for $APP_REVISION: $DETAIL"
            HEALTH=$(echo "$DETAIL" | jq -r '.healthState // "Unknown"')
            ACTIVE=$(echo "$DETAIL" | jq -r '.active // false')
            if [ "$HEALTH" != "Healthy" ] && [ "$HEALTH" != "None" ]; then
              echo "::error::Revision $APP_REVISION is not healthy (healthState: $HEALTH)"
              exit 1
            fi
            if [ "$ACTIVE" != "true" ]; then
              echo "::error::Revision $APP_REVISION is not active"
              exit 1
            fi
            echo "Revision $APP_REVISION verified: healthy=$HEALTH active=$ACTIVE"
          done

      - name: Switch traffic to new revisions
        run: |
          az containerapp ingress traffic set \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --revision-weight "${{ steps.deploy-api.outputs.revision }}=100"

          az containerapp ingress traffic set \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --revision-weight "${{ steps.deploy-web.outputs.revision }}=100"

      - name: Deactivate old revisions
        run: |
          OLD_API=$(az containerapp revision list \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[?name!='${{ steps.deploy-api.outputs.revision }}' && properties.active].name" -o tsv)
          for rev in $OLD_API; do
            echo "Deactivating API revision: $rev"
            az containerapp revision deactivate \
              --name ${{ env.API_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --revision "$rev"
          done

          OLD_WEB=$(az containerapp revision list \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[?name!='${{ steps.deploy-web.outputs.revision }}' && properties.active].name" -o tsv)
          for rev in $OLD_WEB; do
            echo "Deactivating Web revision: $rev"
            az containerapp revision deactivate \
              --name ${{ env.WEB_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --revision "$rev"
          done

      - name: Rollback — deactivate failed staging revisions
        if: failure()
        run: |
          az containerapp revision deactivate \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --revision "${{ steps.deploy-api.outputs.revision }}" 2>/dev/null || true
          az containerapp revision deactivate \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --revision "${{ steps.deploy-web.outputs.revision }}" 2>/dev/null || true

  smoke-test:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get application FQDNs
        id: fqdns
        run: |
          API_FQDN=$(az containerapp show \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          WEB_FQDN=$(az containerapp show \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "api-fqdn=$API_FQDN" >> "$GITHUB_OUTPUT"
          echo "web-fqdn=$WEB_FQDN" >> "$GITHUB_OUTPUT"

      - name: Smoke test API health
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ steps.fqdns.outputs.api-fqdn }}/health/ready")
          if [ "$STATUS" != "200" ]; then
            echo "API health check failed with status $STATUS"
            exit 1
          fi
          echo "API health check passed (HTTP $STATUS)"

      - name: Smoke test Web health
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ steps.fqdns.outputs.web-fqdn }}/health")
          if [ "$STATUS" != "200" ]; then
            echo "Web health check failed with status $STATUS"
            exit 1
          fi
          echo "Web health check passed (HTTP $STATUS)"
