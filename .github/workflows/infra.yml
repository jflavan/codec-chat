name: infra

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: infra-prod
  cancel-in-progress: false

jobs:
  deploy-infra:
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deactivate old container app revisions
        run: |
          # Deactivate all old revisions before infrastructure update to prevent conflicts
          # with secrets and registries being removed during the quickstart phase
          echo "Checking for active revisions on ca-codec-prod-api..."
          ACTIVE_API_REVISIONS=$(az containerapp revision list \
            --name ca-codec-prod-api \
            --resource-group rg-codec-prod \
            --query "[?properties.active].name" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$ACTIVE_API_REVISIONS" ]; then
            for rev in $ACTIVE_API_REVISIONS; do
              echo "Deactivating API revision: $rev"
              az containerapp revision deactivate \
                --name ca-codec-prod-api \
                --resource-group rg-codec-prod \
                --revision "$rev" || echo "Failed to deactivate $rev (may not exist)"
            done
          else
            echo "No active API revisions found or container app doesn't exist yet"
          fi

          echo "Checking for active revisions on ca-codec-prod-web..."
          ACTIVE_WEB_REVISIONS=$(az containerapp revision list \
            --name ca-codec-prod-web \
            --resource-group rg-codec-prod \
            --query "[?properties.active].name" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$ACTIVE_WEB_REVISIONS" ]; then
            for rev in $ACTIVE_WEB_REVISIONS; do
              echo "Deactivating Web revision: $rev"
              az containerapp revision deactivate \
                --name ca-codec-prod-web \
                --resource-group rg-codec-prod \
                --revision "$rev" || echo "Failed to deactivate $rev (may not exist)"
            done
          else
            echo "No active Web revisions found or container app doesn't exist yet"
          fi

      - name: Preview infrastructure changes
        run: |
          az deployment group what-if \
            --resource-group rg-codec-prod \
            --template-file infra/main.bicep \
            --parameters \
              location='centralus' \
              environmentName='prod' \
              googleClientId='${{ secrets.GOOGLE_CLIENT_ID }}' \
              postgresqlAdminPassword='${{ secrets.POSTGRESQL_ADMIN_PASSWORD }}' \
              globalAdminEmail='${{ secrets.GLOBAL_ADMIN_EMAIL }}' \
              webCustomDomain='codec-chat.com' \
              apiCustomDomain='api.codec-chat.com' \
              bindCertificates=true \
              voiceVmEnabled=${{ vars.VOICE_VM_ENABLED == 'true' }} \
              voiceAdminSshPublicKey='${{ secrets.VOICE_ADMIN_SSH_PUBLIC_KEY }}' \
              voiceSshAllowedSourcePrefix='${{ vars.VOICE_SSH_ALLOWED_SOURCE_PREFIX }}' \
              voiceTurnSecret='${{ secrets.VOICE_TURN_SECRET }}' \
              voiceSfuInternalKey='${{ secrets.VOICE_SFU_INTERNAL_KEY }}'

      - name: Deploy infrastructure (register hostnames and create certificates)
        run: |
          az deployment group create \
            --resource-group rg-codec-prod \
            --template-file infra/main.bicep \
            --parameters \
              location='centralus' \
              environmentName='prod' \
              googleClientId='${{ secrets.GOOGLE_CLIENT_ID }}' \
              postgresqlAdminPassword='${{ secrets.POSTGRESQL_ADMIN_PASSWORD }}' \
              globalAdminEmail='${{ secrets.GLOBAL_ADMIN_EMAIL }}' \
              webCustomDomain='codec-chat.com' \
              apiCustomDomain='api.codec-chat.com' \
              bindCertificates=false \
              voiceVmEnabled=${{ vars.VOICE_VM_ENABLED == 'true' }} \
              voiceAdminSshPublicKey='${{ secrets.VOICE_ADMIN_SSH_PUBLIC_KEY }}' \
              voiceSshAllowedSourcePrefix='${{ vars.VOICE_SSH_ALLOWED_SOURCE_PREFIX }}' \
              voiceTurnSecret='${{ secrets.VOICE_TURN_SECRET }}' \
              voiceSfuInternalKey='${{ secrets.VOICE_SFU_INTERNAL_KEY }}'

      - name: Deploy infrastructure (bind certificates to custom domains)
        run: |
          az deployment group create \
            --resource-group rg-codec-prod \
            --template-file infra/main.bicep \
            --parameters \
              location='centralus' \
              environmentName='prod' \
              googleClientId='${{ secrets.GOOGLE_CLIENT_ID }}' \
              postgresqlAdminPassword='${{ secrets.POSTGRESQL_ADMIN_PASSWORD }}' \
              globalAdminEmail='${{ secrets.GLOBAL_ADMIN_EMAIL }}' \
              webCustomDomain='codec-chat.com' \
              apiCustomDomain='api.codec-chat.com' \
              bindCertificates=true \
              voiceVmEnabled=${{ vars.VOICE_VM_ENABLED == 'true' }} \
              voiceAdminSshPublicKey='${{ secrets.VOICE_ADMIN_SSH_PUBLIC_KEY }}' \
              voiceSshAllowedSourcePrefix='${{ vars.VOICE_SSH_ALLOWED_SOURCE_PREFIX }}' \
              voiceTurnSecret='${{ secrets.VOICE_TURN_SECRET }}' \
              voiceSfuInternalKey='${{ secrets.VOICE_SFU_INTERNAL_KEY }}'

      - name: Show deployment outputs
        run: |
          az deployment group show \
            --resource-group rg-codec-prod \
            --name main \
            --query properties.outputs \
            --output table
